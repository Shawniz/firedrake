.. raw:: latex

   \clearpage

.. contents::

====================
Installing Firedrake
====================


.. _supported_systems:

Supported systems
=================

A :ref:`native installation<pip_install_firedrake>` of Firedrake is officially
supported on Ubuntu and macOS though it should be installable on any Linux
distribution. Windows users are encouraged to use WSL_ or one of Firedrake's
:ref:`alternative installation mechanisms<alternative_install>`.


.. _pip_install_firedrake:

Installing Firedrake using pip
==============================

A native installation of Firedrake is accomplished in 3 steps:

#. :ref:`Install system dependencies<install_system_dependencies>`
#. :ref:`Install PETSc<install_petsc>`
#. :ref:`Install Firedrake<install_firedrake>`


.. _prerequisites:

Prerequisites
-------------

On Linux the only prerequisite needed to install Firedrake is a suitable version
of Python (3.10 or greater). On macOS it is important that homebrew_ is installed
and that the homebrew-installed Python is used instead of the system one.


.. _firedrake_configure:

firedrake-configure
-------------------

To simplify the installation process, Firedrake provides a utility script called
``firedrake-configure``. This script can be downloaded by executing::

  $ curl -O https://raw.githubusercontent.com/firedrakeproject/firedrake/master/scripts/firedrake-configure


.. _firedrake_archs:

Prepared configurations
~~~~~~~~~~~~~~~~~~~~~~~

``firedrake-configure`` provides a number of different possible configurations
(termed 'ARCH's) that specify how PETSc is configured and which external
packages are built. The currently supported ARCHs are:

* ``default``: the default installation, suitable for most users
* ``complex``: an installation where PETSc is configured using complex numbers

The different configurations can be selected by passing the flag ``--arch`` to
``firedrake-configure``. For example::

  $ python3 firedrake-configure --show-system-packages --arch complex

If ``--arch`` is not specified then ``default`` is used.


.. _install_system_dependencies:

Installing system dependencies
------------------------------

If on Ubuntu or macOS, system dependencies can be installed with
``firedrake-configure``. On Ubuntu run::

  $ sudo apt install $(python3 firedrake-configure --show-system-packages)

which will install the following packages:

.. literalinclude:: apt_deps.txt
   :language: text

If on macOS you should instead run::

  $ brew install $(python3 firedrake-configure --show-system-packages)

which will install the following packages:

.. literalinclude:: homebrew_deps.txt
   :language: text

If you do not have one of these systems then these dependencies will need to
be installed manually.

.. note::
   Not all the system dependencies declared by ``firedrake-configure`` have to
   be installed at this stage. Some (e.g. HDF5, hwloc) can also be installed
   from source by PETSc during the ``configure`` :ref:`step<install_petsc>` by
   passing additional flags (e.g. ``--download-hdf5``, ``--download-hwloc``).


.. _install_petsc:

Installing PETSc
----------------

For Firedrake to work as expected, it is important that a specific version of PETSc_
is installed with a specific set of external packages. To install PETSc you need to
do the following steps:

#. Clone the PETSc repository::

   $ git clone https://github.com/firedrakeproject/petsc.git
   $ cd petsc

#. Run PETSc ``configure``, passing in the flags generated by ``firedrake-configure``::

   $ ./configure $(python3 ../firedrake-configure --show-petsc-configure-options)

#. Compile PETSc::

   $ make

If you are using one of the
:ref:`officially supported distributions<supported_systems>` then these configure
options will include paths to system packages so PETSc can correctly find and
link against them. If you are not then you should pass the ``--no-package-manager``
flag to obtain a set of configure options where ``firedrake-configure``
pessimistically assumes that no external packages are available, and hence need
to be downloaded and compiled from source::

   $ ./configure $(python3 ../firedrake-configure --no-package-manager --show-petsc-configure-options)

For the ``default`` ARCH, running ``firedrake-configure`` with
``--no-package-manager`` will produce the flags:

.. literalinclude:: petsc_configure_options.txt
   :language: text


Customising the PETSc installation
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Since ``firedrake-configure`` only outputs a string of options it is straightforward
to make changes to the options passed to PETSc ``configure``. You can either:

* Append additional options when ``configure`` is invoked::

   $ ./configure $(python3 ../firedrake-configure --show-petsc-configure-options) --download-exotic-package

* Write the output of ``firedrake-configure`` to a file than can be modified::

   $ python3 ../firedrake-configure --show-petsc-configure-options > my_configure_options.txt
   <edit my_configure_options.txt>
   $ ./configure $(cat my_configure_options.txt)


.. _install_firedrake:

Installing Firedrake
--------------------

Now that the right system packages are installed and PETSc is built we can now
install Firedrake. To do this perform the following steps:

#. Set any necessary environment variables. This can be achieved using
   ``firedrake-configure``::

     $ export $(python3 firedrake-configure --show-env)

   At a minimum this will set the following variables:

   .. code-block:: text

      PETSC_DIR=/path/to/petsc PETSC_ARCH=arch-firedrake-{default,complex} HDF5_MPI=ON

#. Install Firedrake::

     $ pip install --no-binary h5py git+https://github.com/firedrakeproject/firedrake.git

#. Firedrake is now installed and ready for use!

.. note::
   During the installation Firedrake will compile and install petsc4py_. If
   you have previously installed petsc4py on your computer with a different
   PETSc then ``pip`` will erroneously reuse the existing petsc4py which is 
   linked against the wrong library. To avoid this you need to run the
   command::

       pip cache remove petsc4py

   Equivalent commands may also be necessary for mpi4py and h5py if you are
   changing the MPI and/or HDF5 libraries in use.

.. note::
   If you are using an MPI installed into a nonstandard location it may be
   necessary to set some additional environment variables before installation:

   * ``CC`` and ``MPICC`` to the location of ``mpicc``
   * ``CXX`` to the location of ``mpicxx``
   * ``MPI_HOME`` to the base directory of the MPI installation (e.g. ``/usr``
     or ``/opt/mpich``)


Checking the installation
-------------------------

We recommend that you run some simple tests after installation to check
that Firedrake is fully functional. After the installation run::

  $ make -C $VIRTUAL_ENV/src/firedrake check

This command will run a few of the unit tests, which exercise a good
chunk of the functionality of the library. These tests should take a
minute or less. If they fail to run for any reason, please see the
section below on how to :ref:`get help<getting_help>`.

.. note::
   ``make check`` can only be run for Firedrake installed in *editable mode*
   and with its test dependencies. This can be done by running::

     $ pip install --no-binary h5py --editable firedrake@git+https://github.com/firedrakeproject/firedrake.git[test]

   which will install Firedrake into ``$VIRTUAL_ENV/src/firedrake``.


Updating Firedrake
------------------

Updating Firedrake involves following the same steps as above when
:ref:`installing Firedrake<install_firedrake>`. First, use ``firedrake-configure``
to set the right environment variables and then run::

     $ pip install --no-binary h5py --upgrade git+https://github.com/firedrakeproject/firedrake.git

Updating PETSc
~~~~~~~~~~~~~~

To update PETSc you simply need to run::

   $ cd petsc
   $ git pull
   $ make

This will only recompile PETSc's source code, not that of the external
packages, and so should be relatively quick. If your PETSc is sufficiently
out-of-date you may also need to rebuild the external packages by running::

   $ make reconfigure


.. _alternative_install:

Alternative installation methods
================================

As well as being installable through ``pip``, Firedrake also provides
`Docker containers <https://hub.docker.com/u/firedrakeproject>`_ and
Jupyter notebooks running on :doc:`Google Colab</notebooks>`.


.. _getting_help:

Having trouble?
===============

If you struggling to install Firedrake for any reason please
:doc:`get in touch</contact>` either on our Slack channel or create a GitHub
discussion_.

To make debugging easier please make sure to share as much information as you
can including:

* The operating system you are using
* The command you ran and the error that was produced
* Any install logs that are produced (e.g. if PETSc ``configure`` fails please
  make sure to share the ``configure.log`` file)


.. _discussion: https://github.com/firedrakeproject/firedrake/discussions
.. _issue: https://github.com/firedrakeproject/firedrake/issues
.. _homebrew: https://brew.sh/
.. _PETSc: https://www.mcs.anl.gov/petsc/
.. _petsc4py: https://petsc.org/release/petsc4py/reference/petsc4py.html
.. _venv: https://docs.python.org/3/tutorial/venv.html
.. _WSL: https://github.com/firedrakeproject/firedrake/wiki/Installing-on-Windows-Subsystem-for-Linux
