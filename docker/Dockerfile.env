# Dockerfile for an environment into which firedrake can be installed.

FROM ubuntu:latest

# Use a more sane locale
ENV LC_ALL C.UTF-8

# Avoid tzdata prompt
# (https://stackoverflow.com/questions/61388002/how-to-avoid-question-during-the-docker-build)
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Europe/London

RUN apt-get update \
    && apt-get -y install curl python3 sudo

# Change the `ubuntu` user to `firedrake`
# and ensure that we do not run as root on self-hosted systems
RUN usermod -d /home/firedrake -m ubuntu \
    && usermod -l firedrake ubuntu \
    && groupmod -n firedrake ubuntu \
    && usermod -aG sudo firedrake \
    && echo "firedrake:docker" | chpasswd \
    && echo "firedrake ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers \
    && ldconfig

USER firedrake
WORKDIR /home/firedrake

ENV OMP_NUM_THREADS 1
ENV OPENBLAS_NUM_THREADS 1

# # Install system dependencies
# RUN curl -O https://raw.githubusercontent.com/firedrakeproject/firedrake/refs/heads/connorjward/pip-install/scripts/firedrake-system-deps \
#     && sudo apt-get -y install $(python3 firedrake-system-deps)
#
# # Install PETSc
# RUN curl -O https://raw.githubusercontent.com/firedrakeproject/firedrake/refs/heads/connorjward/pip-install/scripts/firedrake-petsc-configure-options \
#     && git clone https://github.com/firedrakeproject/petsc.git \
#     && cd petsc \
#     && ./configure $(python3 ../firedrake-petsc-configure-options) --with-make-np=12 \
#     && make \
#     && cd ..
#
# # RUN git clone https://github.com/firedrakeproject/slepc.git
# # Build default Firedrake SLEPc
# # RUN bash -c 'export PETSC_DIR=/home/firedrake/petsc; \
# #     export PETSC_ARCH=default; \
# #     cd slepc; \
# #     ./configure; \
#     # make SLEPC_DIR=/home/firedrake/slepc PETSC_DIR=/home/firedrake/petsc PETSC_ARCH=default;'
#
# # Additionally build complex PETSc for Firedrake
# # RUN bash -c 'export PACKAGES=/home/firedrake/petsc/packages; \
# #     cd petsc; \
# #     ./configure \
# #         --COPTFLAGS=-O3 -march=native -mtune=native \
# #         --CXXOPTFLAGS=-O3 -march=native -mtune=native \
# #         --FOPTFLAGS=-O3 -march=native -mtune=native \
# #         --with-c2html=0 \
# #         --with-debugging=0 \
# #         --with-fortran-bindings=0 \
# #         --with-make-np=12 \
# #         --with-scalar-type=complex \
# #         --with-shared-libraries=1 \
# #         --with-bison \
# #         --with-flex \
# #         --with-zlib \
# #         --with-fftw-dir=$PACKAGES \
# #         --with-hdf5-dir=$PACKAGES \
# #         --with-hwloc-dir=$PACKAGES \
# #         --with-metis-dir=$PACKAGES \
# #         --with-mpi-dir=$PACKAGES \
# #         --with-mumps-dir=$PACKAGES \
# #         --with-netcdf-dir=$PACKAGES \
# #         --with-pastix-dir=$PACKAGES \
# #         --with-pnetcdf-dir=$PACKAGES \
# #         --with-ptscotch-dir=$PACKAGES \
# #         --with-scalapack-dir=$PACKAGES \
# #         --with-suitesparse-dir=$PACKAGES \
# #         --with-superlu_dist-dir=$PACKAGES \
# #         --with-strict-petscerrorcode \
# #         PETSC_ARCH=complex; \
# #     make PETSC_DIR=/home/firedrake/petsc PETSC_ARCH=complex all;'
#
# # Build complex Firedrake SLEPc
# # RUN bash -c 'export PETSC_DIR=/home/firedrake/petsc; \
# #     export PETSC_ARCH=complex; \
# #     cd slepc; \
# #     ./configure; \
# #     make SLEPC_DIR=/home/firedrake/slepc PETSC_DIR=/home/firedrake/petsc PETSC_ARCH=complex;'
#
# # Set some useful environment variables
# ENV PETSC_DIR /home/firedrake/petsc
# ENV PETSC_ARCH firedrake
# ENV SLEPC_DIR /home/firedrake/slepc
# ENV HDF5_MPI ON
#
